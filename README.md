# Voting App

A Discord-gated voting application built with Next.js, Convex, and NextAuth. Implements a phased voting cycle with Single Transferable Vote (STV) for multi-seat elections.

## Features

- **Discord Authentication**: OAuth login with server membership verification
- **Phased Voting Cycle**: Start → Nomination → Confirmation → Finalization → Voting → Announcement
- **STV Voting**: Single Transferable Vote algorithm for fair multi-seat elections
- **Real-time Updates**: Convex-powered real-time data synchronization
- **Admin Controls**: Cycle management, phase transitions, and result computation
- **Discord Integration**: Daily member sync and automated announcements
- **Dark/Light Theme**: Toggle between themes with persistent preference
- **Test Mode**: Admin test page with dummy users for development

## Tech Stack

- **Next.js 16** (App Router)
- **Convex** (Backend-as-a-Service)
- **NextAuth.js** (Authentication)
- **Discord API** (OAuth & Bot API)
- **TypeScript**
- **Tailwind CSS**
- **shadcn/ui** (UI Components)
- **Bun** (Package Manager)
- **Docker** (Production deployment)

## Prerequisites

- Node.js 18+ or Bun
- Discord Application with Bot
- Convex account (free tier available)

## Quick Start

### 1. Install Dependencies

```bash
bun install
```

### 2. Set Up Convex

```bash
bun run convex:dev
```

This will:
- Prompt you to log in to Convex
- Create a new project (or select existing)
- Generate configuration files
- Start the Convex development server

### 3. Configure Environment Variables

Create a `.env.local` file in the `next-app` directory:

```env
# Discord OAuth
DISCORD_CLIENT_ID=your_discord_client_id
DISCORD_CLIENT_SECRET=your_discord_client_secret

# Discord Bot
DISCORD_BOT_TOKEN=your_discord_bot_token
DISCORD_SERVER_ID=your_discord_server_id
DISCORD_ADMIN_ROLE_IDS=role_id_1,role_id_2
DISCORD_ANNOUNCEMENTS_CHANNEL_ID=your_channel_id

# NextAuth
NEXTAUTH_SECRET=generate_a_random_secret
NEXTAUTH_URL=http://localhost:3000

# Convex (generated by convex dev)
CONVEX_DEPLOYMENT=your_deployment_name
NEXT_PUBLIC_CONVEX_URL=your_convex_url
```

### 4. Discord Bot Setup

1. Go to https://discord.com/developers/applications
2. Create a new application
3. Go to "Bot" section and create a bot
4. Enable "Server Members Intent" in Privileged Gateway Intents
5. Copy the bot token to `DISCORD_BOT_TOKEN`
6. Invite bot to your server with permissions:
   - View Channels
   - Send Messages
   - Read Message History
7. Get your server ID (enable Developer Mode, right-click server → Copy ID)
8. Get admin role IDs (right-click role → Copy ID)

### 5. Discord OAuth Setup

1. In your Discord application, go to "OAuth2" → "General"
2. Add redirect URI: `http://localhost:3000/api/auth/callback/discord`
3. Copy Client ID and Client Secret to environment variables

### 6. Run Development Server

In two separate terminals:

```bash
# Terminal 1: Convex
bunx convex dev

# Terminal 2: Next.js
bunx next dev
```

The app will be available at http://localhost:3000

## Project Structure

```
next-app/
├── app/                    # Next.js App Router pages
│   ├── api/
│   │   ├── auth/           # NextAuth routes
│   │   └── health/         # Health check endpoint
│   ├── admin/              # Admin dashboard
│   ├── voting/             # Main voting page
│   ├── candidates/         # Candidates view
│   ├── results/            # Results page
│   └── test/               # Test page (admin only)
├── components/             # React components
│   ├── ui/                 # UI components (shadcn)
│   ├── phase-bar.tsx       # Phase indicator
│   ├── nav.tsx             # Navigation
│   └── theme-provider.tsx  # Dark/light theme
├── convex/                 # Convex backend
│   ├── schema.ts           # Database schema
│   ├── users.ts            # User functions
│   ├── cycles.ts           # Cycle management
│   ├── ballots.ts          # Ballot handling
│   ├── results.ts          # STV computation
│   ├── discord.ts          # Discord integration
│   └── crons.ts            # Scheduled jobs
├── lib/
│   ├── types.ts            # TypeScript types (derived from schema)
│   └── utils.ts            # Utility functions
├── Dockerfile              # Docker build
├── docker-compose.yml      # Docker orchestration
└── docs/                   # Documentation
```

## Available Scripts

| Command | Description |
|---------|-------------|
| `bun run dev` | Start Next.js dev server |
| `bun run convex:dev` | Start Convex dev server |
| `bun run build` | Build for production |
| `bun run start` | Start production server |
| `bun run lint` | Run ESLint |
| `bunx convex deploy --prod` | Deploy Convex to production |

## Documentation

See the `docs/` folder for detailed documentation:

- [Authentication](docs/authentication.md) - Auth setup and flow
- [Discord Integration](docs/discord-integration.md) - Discord bot and API usage
- [Convex Backend](docs/convex-backend.md) - Backend architecture
- [Voting Cycle](docs/voting-cycle.md) - Phase descriptions and rules
- [STV](docs/stv.md) - Single Transferable Vote algorithm
- [Deployment](docs/deployment.md) - Docker and Vercel deployment

## Usage

### For Administrators

1. Sign in with Discord (must have admin role)
2. Go to Admin page
3. Create a new voting cycle:
   - Set title and number of seats
   - Configure deadlines for each phase
4. Use phase override buttons to test transitions
5. Approve questions during confirmation phase
6. Compute results after voting phase

### For Members

1. Sign in with Discord (must be server member)
2. Set eligibility during Start phase
3. Nominate candidates and submit questions during Nomination phase
4. Vote on questions during Confirmation phase
5. View candidates and answers during Finalization phase
6. Submit ranked ballot during Voting phase
7. View results during Announcement phase

### Test Mode (Admin Only)

Access `/test` to:
- Create dummy users for testing
- Simulate user actions through all phases
- Test the complete voting cycle without real users

## Deployment

### Docker (Self-Hosted)

```bash
# Deploy Convex
bunx convex deploy --prod

# Build and run
docker compose up -d --build
```

See [docs/deployment.md](docs/deployment.md) for full instructions.

## Theme

Toggle dark/light theme using the sun/moon button in the navigation bar. Preference is saved to localStorage.

## Health Check

Health endpoint available at `/api/health`:
```json
{"status":"ok","timestamp":"2024-01-15T12:00:00.000Z"}
```

## License

MIT
